# Script de Setup Inicial do Projeto

Write-Host "`n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
Write-Host "‚ïë  File Processor gRPC - Setup Inicial               ‚ïë" -ForegroundColor Cyan
Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`n" -ForegroundColor Cyan

# Verificar e configurar vcpkg
$vcpkgPath = Join-Path $PSScriptRoot "temp\vcpkg"
if (Test-Path $vcpkgPath) {
    $env:VCPKG_ROOT = $vcpkgPath
    Write-Host "‚úÖ VCPKG_ROOT configurado: $vcpkgPath" -ForegroundColor Green
    
    # Adicionar protoc e grpc_cpp_plugin ao PATH
    $protobufTools = Join-Path $vcpkgPath "installed\x64-windows\tools\protobuf"
    $grpcTools = Join-Path $vcpkgPath "installed\x64-windows\tools\grpc"
    
    if (Test-Path $protobufTools) {
        $env:PATH = "$protobufTools;$env:PATH"
    }
    if (Test-Path $grpcTools) {
        $env:PATH = "$grpcTools;$env:PATH"
    }
} else {
    Write-Host "‚ö†Ô∏è  vcpkg n√£o encontrado em temp\vcpkg" -ForegroundColor Yellow
    Write-Host ""
    Write-Host "   O vcpkg √© necess√°rio para compilar o servidor e cliente C++." -ForegroundColor Gray
    Write-Host "   Voc√™ tem duas op√ß√µes:" -ForegroundColor Gray
    Write-Host ""
    Write-Host "   üì¶ Op√ß√£o 1: Usar Docker (RECOMENDADO - mais f√°cil)" -ForegroundColor Cyan
    Write-Host "      docker-compose build server" -ForegroundColor White
    Write-Host "      docker-compose up -d server" -ForegroundColor White
    Write-Host ""
    Write-Host "   üîß Op√ß√£o 2: Instalar vcpkg localmente (demorado ~30min)" -ForegroundColor Cyan
    Write-Host "      git clone https://github.com/Microsoft/vcpkg.git temp\vcpkg" -ForegroundColor White
    Write-Host "      .\temp\vcpkg\bootstrap-vcpkg.bat" -ForegroundColor White
    Write-Host "      .\temp\vcpkg\vcpkg install protobuf:x64-windows grpc:x64-windows" -ForegroundColor White
    Write-Host ""
    Write-Host "   ‚ö° Para continuar apenas com Python (sem C++):" -ForegroundColor Cyan
    Write-Host "      Este script vai configurar o cliente Python e voc√™ pode usar o servidor via Docker." -ForegroundColor Gray
    Write-Host ""
    
    $response = Read-Host "Deseja continuar sem vcpkg? (s/N)"
    if ($response -notmatch '^[sS]') {
        Write-Host "`n‚ùå Setup cancelado. Instale o vcpkg ou use Docker." -ForegroundColor Red
        exit 1
    }
    
    Write-Host "`nüìù Continuando sem compila√ß√£o C++..." -ForegroundColor Yellow
    Write-Host ""
}

Write-Host ""

$steps = @(
    @{ Name = "Verificar Python"; Step = 1; Total = 7 }
    @{ Name = "Verificar Ferramentas"; Step = 2; Total = 7 }
    @{ Name = "Instalar Depend√™ncias Python"; Step = 3; Total = 7 }
    @{ Name = "Gerar C√≥digo Protobuf"; Step = 4; Total = 7 }
    @{ Name = "Compilar Projeto"; Step = 5; Total = 7 }
    @{ Name = "Preparar Arquivos de Teste"; Step = 6; Total = 7 }
    @{ Name = "Verificar Instala√ß√£o"; Step = 7; Total = 7 }
)

function Write-Step {
    param($StepInfo)
    Write-Host "`n[$($StepInfo.Step)/$($StepInfo.Total)] $($StepInfo.Name)..." -ForegroundColor Yellow
    Write-Host ("‚îÄ" * 60) -ForegroundColor Gray
}

# Passo 1: Verificar Python
Write-Step $steps[0]

$pythonVersion = python --version 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "‚úÖ Python encontrado: $pythonVersion" -ForegroundColor Green
} else {
    Write-Host "‚ùå Python n√£o encontrado!" -ForegroundColor Red
    Write-Host "   Instale Python 3.8+ de: https://www.python.org/downloads/" -ForegroundColor Yellow
    exit 1
}

# Passo 2: Verificar Ferramentas
Write-Step $steps[1]

$tools = @{
    "CMake" = "cmake"
    "Protoc" = "protoc"
    "Ghostscript" = @("gswin64c", "gs")
    "ImageMagick" = @("magick", "convert")
    "Poppler (pdftotext)" = "pdftotext"
}

$missingTools = @()

foreach ($tool in $tools.GetEnumerator()) {
    $found = $false
    $commands = if ($tool.Value -is [Array]) { $tool.Value } else { @($tool.Value) }
    
    foreach ($cmd in $commands) {
        if (Get-Command $cmd -ErrorAction SilentlyContinue) {
            Write-Host "‚úÖ $($tool.Key) encontrado" -ForegroundColor Green
            $found = $true
            break
        }
    }
    
    if (-not $found) {
        Write-Host "‚ö†Ô∏è  $($tool.Key) n√£o encontrado" -ForegroundColor Yellow
        $missingTools += $tool.Key
    }
}

if ($missingTools.Count -gt 0) {
    Write-Host "`n‚ö†Ô∏è  Ferramentas ausentes: $($missingTools -join ', ')" -ForegroundColor Yellow
    Write-Host "   O projeto pode ter funcionalidades limitadas." -ForegroundColor Yellow
    Write-Host ""
    
    # Instru√ß√µes espec√≠ficas para Ghostscript
    if ($missingTools -contains "Ghostscript") {
        Write-Host "   üìÑ Para instalar Ghostscript:" -ForegroundColor Cyan
        Write-Host "      ‚Ä¢ Download manual: https://ghostscript.com/releases/gsdnld.html" -ForegroundColor Gray
        Write-Host "      ‚Ä¢ Via Chocolatey: choco install ghostscript -y" -ForegroundColor Gray
        Write-Host "      ‚Ä¢ Ap√≥s instalar, adicione ao PATH: C:\Program Files\gs\gs10.xx.x\bin" -ForegroundColor Gray
        Write-Host ""
    }
    
    Write-Host "   Para mais informa√ß√µes, consulte README.md se√ß√£o 3.1" -ForegroundColor Yellow
}

# Passo 3: Instalar Depend√™ncias Python
Write-Step $steps[2]

$venvPath = "client_python\venv"
$requirementsFile = "client_python\requirements.txt"

# Criar venv se n√£o existir
if (-not (Test-Path $venvPath)) {
    Write-Host "üì¶ Criando ambiente virtual Python..." -ForegroundColor Yellow
    python -m venv $venvPath
    
    if ($LASTEXITCODE -ne 0) {
        Write-Host "‚ùå Erro ao criar ambiente virtual" -ForegroundColor Red
        Write-Host "   Instalando no Python global..." -ForegroundColor Yellow
        $useVenv = $false
    } else {
        Write-Host "‚úÖ Ambiente virtual criado" -ForegroundColor Green
        $useVenv = $true
    }
} else {
    Write-Host "‚úÖ Ambiente virtual j√° existe" -ForegroundColor Green
    $useVenv = $true
}

# Ativar venv e instalar depend√™ncias
if ($useVenv) {
    Write-Host "üîß Ativando ambiente virtual..." -ForegroundColor Cyan
    $activateScript = "$venvPath\Scripts\Activate.ps1"
    
    if (Test-Path $activateScript) {
        & $activateScript
        Write-Host "‚úÖ Ambiente virtual ativado" -ForegroundColor Green
    }
}

# Atualizar pip
Write-Host "üì¶ Atualizando pip..." -ForegroundColor Yellow
python -m pip install --upgrade pip --quiet

# Instalar depend√™ncias com wheels pr√©-compilados
if (Test-Path $requirementsFile) {
    Write-Host "üì¶ Instalando depend√™ncias do requirements.txt..." -ForegroundColor Yellow
    Write-Host "   (usando wheels pr√©-compilados, sem compilar c√≥digo-fonte)" -ForegroundColor Gray
    
    # For√ßar uso de wheels (bin√°rios pr√©-compilados)
    python -m pip install --only-binary :all: -r $requirementsFile 2>$null
    
    if ($LASTEXITCODE -ne 0) {
        Write-Host "‚ö†Ô∏è  Vers√µes bin√°rias n√£o dispon√≠veis, tentando compilar..." -ForegroundColor Yellow
        python -m pip install -r $requirementsFile
        
        if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ö†Ô∏è  Erro na instala√ß√£o completa" -ForegroundColor Yellow
            Write-Host "   Tentando vers√£o mais recente com bin√°rios..." -ForegroundColor Yellow
            
            # Tentar vers√£o mais recente que tem wheels para Python 3.13
            python -m pip install --upgrade grpcio grpcio-tools protobuf
        }
    }
    
    # Verificar se instala√ß√£o funcionou
    python -c "import grpc_tools" 2>$null
    if ($LASTEXITCODE -eq 0) {
        Write-Host "‚úÖ Depend√™ncias Python instaladas com sucesso" -ForegroundColor Green
    } else {
        Write-Host "‚ö†Ô∏è  grpc_tools pode n√£o estar instalado corretamente" -ForegroundColor Yellow
    }
} else {
    Write-Host "‚ö†Ô∏è  Arquivo requirements.txt n√£o encontrado" -ForegroundColor Yellow
    Write-Host "   Instalando vers√µes mais recentes..." -ForegroundColor Yellow
    python -m pip install --upgrade grpcio grpcio-tools protobuf
}

# Passo 4: Gerar C√≥digo Protobuf
Write-Step $steps[3]

Write-Host "Executando generate_proto.ps1..." -ForegroundColor Cyan
& .\scripts\generate_proto.ps1

if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå Erro ao gerar c√≥digo protobuf!" -ForegroundColor Red
    Write-Host "   Verifique se protoc e grpc_cpp_plugin est√£o no PATH" -ForegroundColor Yellow
    exit 1
}

# Passo 5: Compilar Projeto
Write-Step $steps[4]

if (Test-Path $vcpkgPath) {
    Write-Host "Compilando servidor e clientes..." -ForegroundColor Cyan
    & .\scripts\build.ps1 -All

    if ($LASTEXITCODE -ne 0) {
        Write-Host "‚ùå Erro durante compila√ß√£o!" -ForegroundColor Red
        Write-Host "   Verifique os logs acima para detalhes" -ForegroundColor Yellow
        exit 1
    }
} else {
    Write-Host "‚è≠Ô∏è  Pulando compila√ß√£o C++ (vcpkg n√£o dispon√≠vel)" -ForegroundColor Yellow
    Write-Host "   Use Docker para rodar o servidor:" -ForegroundColor Gray
    Write-Host "   docker-compose up -d server" -ForegroundColor White
    Write-Host ""
}

# Passo 6: Preparar Arquivos de Teste
Write-Step $steps[5]

Write-Host "Preparando arquivos de teste..." -ForegroundColor Cyan
& .\scripts\prepare_test_files.ps1

# Passo 7: Verifica√ß√£o Final
Write-Step $steps[6]

Write-Host "`nVerificando instala√ß√£o..." -ForegroundColor Cyan

$checks = @{
    "Cliente Python configurado" = "client_python\venv\Scripts\python.exe"
    "C√≥digo protobuf gerado (Python)" = "client_python\generated\file_processor_pb2.py"
}

# Adicionar verifica√ß√µes C++ apenas se vcpkg existe
if (Test-Path $vcpkgPath) {
    $checks["Servidor compilado"] = @("server_cpp\build\*\file_processor_server.exe", "server_cpp\build\file_processor_server.exe")
    $checks["Cliente C++ compilado"] = @("client_cpp\build\*\file_processor_client.exe", "client_cpp\build\file_processor_client.exe")
    $checks["C√≥digo protobuf gerado (C++)"] = "server_cpp\generated\file_processor.pb.h"
}

$allOk = $true

foreach ($check in $checks.GetEnumerator()) {
    $found = $false
    $paths = if ($check.Value -is [Array]) { $check.Value } else { @($check.Value) }
    
    foreach ($path in $paths) {
        if (Test-Path $path) {
            Write-Host "‚úÖ $($check.Key)" -ForegroundColor Green
            $found = $true
            break
        }
    }
    
    if (-not $found) {
        Write-Host "‚ùå $($check.Key)" -ForegroundColor Red
        $allOk = $false
    }
}

# Resumo Final
Write-Host "`n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
Write-Host "‚ïë                    RESUMO                         ‚ïë" -ForegroundColor Cyan
Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan

if ($allOk) {
    Write-Host "`n‚úÖ Setup conclu√≠do com sucesso!" -ForegroundColor Green
    Write-Host "`nPr√≥ximos passos:" -ForegroundColor Cyan
    Write-Host ""
    
    if (Test-Path $vcpkgPath) {
        Write-Host "1Ô∏è‚É£  Iniciar o servidor:" -ForegroundColor White
        Write-Host "   .\scripts\run_server.ps1" -ForegroundColor Gray
        Write-Host ""
        Write-Host "2Ô∏è‚É£  Em outro terminal, executar cliente:" -ForegroundColor White
        Write-Host "   .\scripts\run_client_python.ps1" -ForegroundColor Gray
        Write-Host "   ou" -ForegroundColor Gray
        Write-Host "   .\scripts\run_client_cpp.ps1" -ForegroundColor Gray
    } else {
        Write-Host "1Ô∏è‚É£  Iniciar o servidor via Docker:" -ForegroundColor White
        Write-Host "   docker-compose up -d server" -ForegroundColor Gray
        Write-Host ""
        Write-Host "2Ô∏è‚É£  Em outro terminal, executar cliente Python:" -ForegroundColor White
        Write-Host "   .\scripts\run_client_python.ps1" -ForegroundColor Gray
    }
    
    Write-Host ""
    Write-Host "3Ô∏è‚É£  Executar testes (com servidor rodando):" -ForegroundColor White
    Write-Host "   .\scripts\run_tests.ps1" -ForegroundColor Gray
    Write-Host ""
    Write-Host "üìö Consulte QUICKSTART.md para mais informa√ß√µes" -ForegroundColor Cyan
    Write-Host ""
} else {
    Write-Host "`n‚ö†Ô∏è  Setup completado com avisos" -ForegroundColor Yellow
    
    if (-not (Test-Path $vcpkgPath)) {
        Write-Host "`nCompila√ß√£o C++ n√£o realizada (vcpkg n√£o dispon√≠vel)." -ForegroundColor Yellow
        Write-Host ""
        Write-Host "‚úÖ Cliente Python configurado com sucesso!" -ForegroundColor Green
        Write-Host ""
        Write-Host "Para usar o projeto:" -ForegroundColor Cyan
        Write-Host "  1. Inicie o servidor via Docker:" -ForegroundColor White
        Write-Host "     docker-compose up -d server" -ForegroundColor Gray
        Write-Host ""
        Write-Host "  2. Use o cliente Python:" -ForegroundColor White
        Write-Host "     .\scripts\run_client_python.ps1" -ForegroundColor Gray
        Write-Host ""
        Write-Host "  3. Execute os testes:" -ForegroundColor White
        Write-Host "     .\scripts\run_tests.ps1" -ForegroundColor Gray
        Write-Host ""
    } else {
        Write-Host "`nAlguns componentes n√£o foram compilados corretamente." -ForegroundColor Yellow
        Write-Host "Revise os erros acima e consulte QUICKSTART.md" -ForegroundColor Yellow
        Write-Host ""
        exit 1
    }
}
